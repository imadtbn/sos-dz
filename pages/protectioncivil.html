<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>وحدات الحماية المدنية - الطوارئ والنجدة</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap">

    <!-- أيقونة الموقع -->
    <link rel="icon" href="../icons/najda_icon_1.png" alt="icon" type="image/png" loading="lazy" class="welcome-logo">

    <meta name="description"
        content="منصة النجدة والطوارئ في الجزائر لتحديد أقرب خدمات الإسعاف، الحماية المدنية، الشرطة، مخابر التحاليل البيولوجية، الصيدليات، الأطباء وجرّ السيارات بسرعة ودقة عبر الموقع الجغرافي. وصول فوري لأرقام الطوارئ والخدمات القريبة منك في جميع الولايات.">
    <!-- لون شريط المتصفح -->
    <meta name="theme-color" content="#1d3557">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">

    <meta name="theme-color" media="(prefers-color-scheme: light)" content="#1d3557">
    <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#0f1f33">

    <!-- أيقونة الموقع -->
    <link rel="icon" type="image/png" sizes="32x32" href="../icons/najda_icon_3.png">
    <link rel="icon" type="image/png" sizes="192x192" href="../icons/najda_icon_3.png">
    <link rel="apple-touch-icon" sizes="180x180" href="../icons/najda_icon_3.png">

    <link rel="stylesheet" href="../style/protectioncivile.css">
    <link rel="stylesheet" href="../style/SidebarAnimation.css">


</head>

<body>

    <header>
        <div class="container header-content">
            <div class="logo">
                <img src="../icons/dgpc.svg" alt="شعار النجدة Dz" width="50" height="50" loading="lazy">
                <h1>الحماية المدنية</h1>
            </div>
            <button class="menu-toggle" id="menuToggle">
                <i class="fas fa-bars"></i>
            </button>

            <div class="nav-overlay" id="navOverlay"></div>

            <nav class="nav-links" id="navLinks">
                <button class="close-menu" id="closeMenu">
                    <i class="fas fa-times"></i>
                </button>
                <a href="../index.html">الرئيسية</a>
                <a href="police.html">مراكز الشرطة</a>
                <a href="gendarmerie.html" >الدرك الوطني</a>
                <a href="protectioncivil.html" class="active">الحماية المدنية</a>
                <a href="depannage.html" >جر السيارات</a>
                <a href="subscription.html">إشتراك </a>
            </nav>
        </div>
    </header>

    <section class="hero">
        <div class="container">
            <h2>أقرب وحدات الحماية المدنية</h2>
            <p>اعثر على الوحدة الأقرب في حالات الطوارئ</p>
            <div class="location-access">
                <button id="getLocation" class="btn"><i class="fas fa-map-marker-alt"></i> تحديث الموقع</button>
            </div>
            <div id="locationStatus" style="color: #ffdddd;"></div>
        </div>
    </section>

    <!-- قسم البحث الاحترافي -->
    <div class="search-container">
        <div class="search-box">
            <i class="fas fa-search search-icon"></i>
            <input type="text" id="searchInput" placeholder="ابحث عن وحدات الحماية المدنية ...">
        </div>
    </div>




    <div class="container">
        <div id="unitsList" class="units-grid">
            <!-- سيتم ملؤها بالبيانات -->
            <div class="spinner"></div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="container footer-content">
            <div class="footer-grid">

                <!-- تعريف -->
                <div class="footer-col">
                    <div class="footer-logo">
                        <h2>النجدة Dz</h2>
                        <p>منصة وطنية لتحديد أقرب خدمات النجدة والطوارئ في الجزائر بدقة وسرعة.</p>
                        <img src="../icons/najda_icon_11.png" alt="شعار النجدة Dz" loading="lazy">
                    </div>

                </div>

                <!-- خدمات الطوارئ -->
                <div class="footer-col">
                    <h4><i class="fas fa-ambulance"></i> خدمات النجدة والطوارئ</h4>
                    <ul>
                        <li><a href="hospitals.html"><i class="fas fa-hospital"></i> المستشفيات</a></li>
                        <li><a href="police.html"><i class="fas fa-shield-alt"></i> مراكز الشرطة</a></li>
                        <li><a href="gendarmerie.html"><i class="fas fa-star"></i> الدرك الوطني</a></li>
                        <li><a href="protectioncivil.html"><i class="fas fa-fire-extinguisher"></i> الحماية
                                المدنية</a></li>
                                <li><a href="depannage.html"><i class="fas fa-truck-pickup"></i> جر ورأب السيارات</a></li>

                    </ul>
                </div>

                <!-- خدمات صحية -->
                <div class="footer-col">
                    <h4><i class="fas fa-heartbeat"></i> خدمات صحية</h4>
                    <ul>
                        <ul>
                            <li><a href="doctors.html"><i class="fas fa-user-md"></i>أطباء مختلف التخصصات</a></li>
                            <li><a href="laboratories.html"><i class="fas fa-vials"></i> مخابر التحاليل البيولوجية</a>
                            </li>
                            <li><a href="pharmacies.html"><i class="fas fa-capsules"></i> الصيدليات</a></li>
                        </ul>
                    </ul>
                </div>

                <!-- روابط مهمة -->
                <div class="footer-col">
                    <h4><i class="fas fa-link"></i> روابط مهمة</h4>
                    <ul>
                        <li><a href="about.html"><i class="fas fa-info-circle"></i> عن الموقع</a></li>
                        <li><a href="contact.html"><i class="fas fa-envelope"></i> اتصل بنا</a></li>
                        <li><a href="privacy.html"><i class="fas fa-user-shield"></i> سياسة الخصوصية</a>
                        </li>
                        <li><a href="guide.html"><i class="fas fa-book"></i> الإرشادات</a></li>
                        <li><a href="subscription.html"><i class="fas fa-id-card"></i>الإشتراك في خدمات النجدة</a></li>

                    </ul>
                </div>

            </div>

            <div class="footer-bottom">
                <p>جميع الحقوق محفوظة &copy; 2026</p>
            </div>

        </div>

        <!-- زر الرجوع للأعلى -->
        <button id="scrollTopBtn"><i class="fas fa-arrow-up"></i></button>
    </footer>

    <!-- إضافة رابط ملف البيانات قبل الـ script -->
    <script src="../script/units-data.js"></script>

    <!--  القائمة الجانبية  script -->
    <script src="script/SidebarAnimation.js"></script>

    <script>

        // بداية السكربت
        let userLat = null, userLon = null;

        // استرجاع الموقع المخزن
        const savedLat = localStorage.getItem('userLat');
        const savedLon = localStorage.getItem('userLon');
        const savedTime = localStorage.getItem('locationTimestamp');
        const ONE_HOUR = 60 * 60 * 1000;

        if (savedLat && savedLon && savedTime && (Date.now() - savedTime < ONE_HOUR)) {
            userLat = parseFloat(savedLat);
            userLon = parseFloat(savedLon);
            document.getElementById('locationStatus').innerHTML =
                '<i class="fas fa-check-circle"></i> تم استخدام موقعك المخزن';
            displayUnits();
        } else {
            displayUnits(); // عرض بدون ترتيب
        }


        // دالة حساب المسافة (هافرسين)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // عرض الوحدات مرتبة حسب المسافة
        function displayUnits() {
            const container = document.getElementById('unitsList');
            if (!userLat || !userLon) {
                // إذا لم يحدد الموقع، عرض الوحدات بدون ترتيب
                let html = '';
                unitsData.forEach(u => {
                    html += renderUnitCard(u, null);
                });
                container.innerHTML = html || '<p>لا توجد بيانات</p>';
                return;
            }

            // حساب المسافة لكل وحدة وترتيبها
            const withDistance = unitsData.map(u => {
                const dist = calculateDistance(userLat, userLon, u.lat, u.lon);
                return { ...u, distance: dist };
            }).sort((a, b) => a.distance - b.distance);

            let html = '';
            withDistance.forEach(u => {
                html += renderUnitCard(u, u.distance.toFixed(1));
            });
            container.innerHTML = html;
        }

        function renderUnitCard(u, distance) {
            const distText = distance ? `<div class="distance-badge"><i class="fas fa-location-dot"></i> ${distance} كم</div>` : '';
            const googleMapsLink = `https://www.google.com/maps/dir/?api=1&destination=${u.lat},${u.lon}`;

            // تنظيف رقم الهاتف من الرموز غير الرقمية (الشرطات، المسافات) مع الاحتفاظ بـ +
            const cleanPhone = u.phone ? u.phone.replace(/[^\d+]/g, '') : '';

            return `
        <div class="unit-card">
            <div class="unit-icon"><i class="fas fa-fire-extinguisher"></i></div>
            <div class="unit-name">${u.name}</div>
            <div class="unit-detail"><i class="fas fa-map-marker-alt"></i> ولاية: ${u.wilaya} - بلدية: ${u.baladia}</div>
            <div class="unit-detail">
                <i class="fas fa-phone"></i> 
                <a href="tel:${cleanPhone}" class="phone-card-link" dir="ltr" style="text-decoration:none; color:inherit;">${u.phone}</a>
            </div>
            ${distText}
            <a href="${googleMapsLink}" target="_blank" class="google-route-btn"><i class="fab fa-google"></i> التوجه عبر خرائط Google</a>
        </div>
    `;
        }

        // تحديد الموقع الجغرافي
        document.getElementById('getLocation').addEventListener('click', function () {
            const status = document.getElementById('locationStatus');
            if (!navigator.geolocation) {
                status.innerText = 'المتصفح لا يدعم تحديد الموقع';
                return;
            }
            status.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري تحديد الموقع...';
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    userLat = position.coords.latitude;
                    userLon = position.coords.longitude;
                    status.innerHTML = `<i class="fas fa-check-circle"></i> تم تحديد موقعك بنجاح`;
                    displayUnits();
                },
                (error) => {
                    status.innerText = 'فشل تحديد الموقع: ' + error.message;
                    displayUnits(); // عرض بدون ترتيب
                }
            );
        });

        // عرض أولي بدون موقع
        displayUnits();

        // عناصر البحث
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');

        // دالة البحث
        function performSearch() {
            const query = searchInput.value.trim().toLowerCase();
            if (query === '') {
                // إعادة عرض جميع البيانات (بدون موقع)
                displayUnits(); // تأكد من أن هذه الدالة معرفة في الصفحة
                return;
            }

            // تصفية البيانات (unitsData هي المصفوفة العامة)
            const filtered = unitsData.filter(item => {
                return item.name.toLowerCase().includes(query) ||
                    (item.wilaya && item.wilaya.toLowerCase().includes(query)) ||
                    (item.baladia && item.baladia.toLowerCase().includes(query)) ||
                    (item.phone && item.phone.includes(query));
            });

            // عرض النتائج
            const container = document.getElementById('unitsList');
            if (filtered.length === 0) {
                // رسالة عدم وجود نتائج + رابط بحث Google
                const googleSearchUrl = `https://www.google.com/search?q=${encodeURIComponent(query)}+الجزائر+الحماية+المدنية`;
                container.innerHTML = `
            <div class="no-results">
                <i class="fas fa-exclamation-triangle"></i>
                <p>لم نتمكن من العثور على "${searchInput.value}" في قاعدة بياناتنا.</p>
                <p>قد تجد النتائج التي تبحث عنها عبر 
                    <a href="${googleSearchUrl}" target="_blank" class="google-fallback-link">
                        <i class="fab fa-google"></i> بحث Google
                    </a>
                </p>
            </div>
        `;
            } else {
                // عرض النتائج
                let html = '';
                filtered.forEach(item => {
                    html += renderUnitsCard(item, null);
                });
                container.innerHTML = html;
            }
        }

        document.getElementById("searchInput").addEventListener("keyup", function (e) {
            if (e.key === "Enter") {
                performSearch(unitsData); // ضع اسم دالة البحث الخاصة بك هنا
            }

            const searchInput = document.getElementById("searchInput");

            searchInput.addEventListener("keyup", function (e) {

                const value = this.value.trim();

                // إذا تم مسح البحث بالكامل
                if (value === "") {
                    displayUnits(unitsData);
                    // استبدل displayLaboratories بدالة عرض البيانات الأصلية عندك
                    return;
                }

                // تنفيذ البحث عند الضغط على Enter
                if (e.key === "Enter") {
                    performSearch(unitsData);
                }
            });

        });

        // أحداث البحث
        searchBtn.addEventListener('click', performSearch);
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') performSearch();
        });

        // دالة عرض البطاقة (معدلة برقم هاتف قابل للنقر)
        function renderUnitsCard(unit, distance) {
            const distText = distance ? `<div class="distance-badge"><i class="fas fa-location-dot"></i> ${distance} كم</div>` : '';
            const googleMapsLink = `https://www.google.com/maps/dir/?api=1&destination=${unit.lat},${unit.lon}`;

            // تنظيف رقم الهاتف
            const cleanPhone = unit.phone ? unit.phone.replace(/[^\d+]/g, '') : '';
            const phoneLink = unit.phone
                ? `<a href="tel:${cleanPhone}" class="phone-card-link" dir="ltr" style="text-decoration:none; color:inherit;">${unit.phone}</a>`
                : '';

            return `
        <div class="unit-card">
            <div class="unit-icon"><i class="fas fa-fire-extinguisher"></i></div>
            <div class="unit-name">${unit.name}</div>
            <div class="unit-detail"><i class="fas fa-map-marker-alt"></i> ولاية: ${unit.wilaya} - بلدية: ${unit.baladia}</div>
            <div class="unit-detail">
                <i class="fas fa-phone"></i> 
                ${phoneLink}
            </div>
            ${distText}
            <a href="${googleMapsLink}" target="_blank" class="google-route-btn"><i class="fab fa-google"></i> التوجه عبر خرائط Google</a>
        </div>
    `;
        }

    </script>



</body>

</html>